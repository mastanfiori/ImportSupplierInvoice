/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","sap/m/MessageBox","fin/ap/invoice/upload/util/ValueHelp","fin/ap/invoice/upload/util/Constants"],function(O,M,V,C){"use strict";return O.extend("fin.ap.invoice.upload.util.EditDialog",{_oController:undefined,_aEntry:[],_aFieldName:["PostingDate","DocumentDate","InvoicingParty","DocumentType","PaymentTerm","HeaderText"],_aField:{},_oDefaultDateFormat:undefined,_oDateFormatyyyymmdd:undefined,constructor:function(c,e){this._oController=c;this._aEntry=e;},init:function(){for(var i=0;i<this._aFieldName.length;i++){this._init(this._aFieldName[i]);}this._oDefaultDateFormat=sap.ui.core.format.DateFormat.getDateInstance({style:'medium'});this._oDateFormatyyyymmdd=sap.ui.core.format.DateFormat.getInstance({pattern:"yyyyMMdd",calendarType:sap.ui.core.CalendarType.Gregorian});},_init:function(f){var F=f+"ID";var d=this._oController.byId(C[F]);var c,D;d.setName(f);if(f==="PostingDate"||f==="DocumentDate"){c=false;D=true;}else{c=true;D=false;}var o={oDropdown:d,isComboBox:c,isDate:D,OldKey:C.KeepExistingValue,OldValue:this._oController.getResourceBundle().getText("Keep")};this._aField[f]=o;},onPostingDateSelectionChange:function(e){this._onSelectionChange(e);this.onChange(e);},onDocumentDateSelectionChange:function(e){this._onSelectionChange(e);this.onChange(e);},onInvoicePartySelectionChange:function(e){var c=["LAND1","MCOD3","SORTL","MCOD1","LIFNR","BUKRS"];this._onSelectionChange(e,"VHInvoicingParty","VL_SH_ODATA_KREDI","LIFNR",c);},onDocumentTypeSelectionChange:function(e){var c=["BLART","LTEXT"];this._onSelectionChange(e,"VHDocumentType","VL_SH_FAP_T003","BLART",c);},onPaymentTermSelectionChange:function(e){var c=["PAYMENTTERMS","PAYMENTTERMSNAME"];this._onSelectionChange(e,"VHPaymentTerm","VL_SH_ODATA_ZTERM","PAYMENTTERMS",c);},onHeaderTextSelectionChange:function(e){this._onSelectionChange(e);},_onSelectionChange:function(e,v,s,a,b){var c=this._oController;var d=e.getSource();var S=d.getProperty("selectedKey");switch(S){case C.UseValueHelp:{var o=new V(c,this,d,v,s,a,b);o.openValueHelp();break;}case C.SelectNewDate:{if(!this._oCalendarPopover){this._oCalendarPopover=sap.ui.xmlfragment(this._oController.getView().getId(),C.CalendarFragmentID,this);this._oController.getView().addDependent(this._oCalendarPopover);}jQuery.sap.delayedCall(0,this,function(){this._oCalendarPopover.openBy(d);});break;}default:break;}},onChange:function(e){var d=e.getSource();var s=d.getProperty("selectedKey");var f=d.getName();var u=this._oController.getView().getModel("ui");d.setValueState(sap.ui.core.ValueState.None);d.setValueStateText();u.setProperty("/editOkBtnEnabled",true);switch(s){default:{this.storeFieldOldKeyValue(f,s,d.getItemByKey(s).getText());break;}case C.ComboBoxUserInput:{this._checkInputLength(d,f);this.storeFieldOldKeyValue(f,s,d.getValue());break;}case C.UseValueHelp:break;case C.SelectNewDate:break;}},_checkInputLength:function(d,f){var u=this._oController.getView().getModel("ui");var e="MassChange";var F="/#"+e+"/"+f+"/@maxLength";var s=d.getValue();var a=s.trim();var n=a.length;var b=this._oController.oDataModel.getProperty(F);if(n>b){d.setValueState(sap.ui.core.ValueState.Error);d.setValueStateText(this._oController.getResourceBundle().getText("InputLong",b));u.setProperty("/editOkBtnEnabled",false);}else if(s!==a){d.setValue(a);d.setValueState(sap.ui.core.ValueState.Warning);d.setValueStateText(this._oController.getResourceBundle().getText("RemoveWhitespace"));}if(n===0){d.setSelectedKey(C.LeaveBlank);d.setValue(d.getItemByKey(C.LeaveBlank).getText());}},onCancelPress:function(e){this._oController._oEditDialog.close();},onOkPress:function(){var t=this;var s=function(f,p){var F=t._aField[f];var a=F.oDropdown.getSelectedKey();var S=function(F){var d=F.oDropdown;var b=(F.isComboBox)?d.getValue():d.getItemByKey(a).getText();if(F.isDate){var D=t._oDefaultDateFormat.parse(b,true);b=t._oDateFormatyyyymmdd.format(D);}return b;};switch(a){case C.ComboBoxUserInput:{p[f]=S(F);break;}case C.SelectUserInput:{p[f]=S(F);break;}case C.LeaveBlank:{p[f]="";break;}default:break;}return p;};var u={};for(var i=0;i<this._aFieldName.length;i++){var f=this._aFieldName[i];u=s(f,u);}this._oController._oEditDialog.close();if((!jQuery.isEmptyObject(u))){this._oController._doActionSelectedDocuments("Update",this._aEntry,"",u);}},storeFieldOldKeyValue:function(f,k,v){this._aField[f].OldKey=k;this._aField[f].OldValue=v;},setBackFieldOldKeyValue:function(f){var F=this._aField[f];var d=F.oDropdown;if(F.isComboBox){d.setSelectedKey(F.OldKey);d.setValue(F.OldValue);}else{d.getItemByKey(F.OldKey).setText(F.OldValue);d.setSelectedKey(F.OldKey);}},beforeCalendarPopoverClose:function(e){var s=e.getParameters().openBy;var f=s.getName();if(this._sSelectedDate){if(!s.getItemByKey(C.SelectUserInput)){var i=new sap.ui.core.Item({key:C.SelectUserInput,text:this._sSelectedDate});s.addItem(i);}else{s.getItemByKey(C.SelectUserInput).setText(this._sSelectedDate);}s.setSelectedKey(C.SelectUserInput);this.storeFieldOldKeyValue(f,C.SelectUserInput,this._sSelectedDate);}else{this.setBackFieldOldKeyValue(f);}this._sSelectedDate="";},handleCalendarSelect:function(e){var c=e.getSource();var s=c.getSelectedDates();if(s.length>0){var d=s[0].getStartDate();this._sSelectedDate=this._oDefaultDateFormat.format(d);}this._oCalendarPopover.close();}});});
