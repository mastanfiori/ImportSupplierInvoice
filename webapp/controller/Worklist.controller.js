/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["fin/ap/invoice/upload/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","fin/ap/invoice/upload/model/formatter","fin/ap/invoice/upload/util/Constants","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Item","sap/ui/model/Sorter","sap/m/MessageToast","sap/m/MessageBox","sap/m/Dialog","sap/ui/core/IconPool","fin/ap/invoice/upload/util/EditDialog"],function(B,J,H,f,C,F,a,I,S,M,b,D,c,E){"use strict";return B.extend("fin.ap.invoice.upload.controller.Worklist",{formatter:f,_oPage:undefined,_oDownloadDialog:undefined,_oWorklistSmartTable:undefined,_oWorklistTable:undefined,_iActionTotalNum:0,_iActionNotFinished:0,_iActionSuccessNum:0,_iDuplicateCheckNotFinished:0,_aEntriesNotDuplicate:[],_aSelectedItems:[],onInit:function(){B.prototype.onInit.call(this);this._oPage=this.byId("fin.ap.invoice.upload.UploadPage");this._oWorklistSmartTable=this.byId(C.UploadPageWorklistSmartTableID);this._oWorklistTable=this.byId(C.UploadPageWorklistTableID);this.getView().addStyleClass(this.getOwnerComponent().getContentDensityClass());this._oWorklistSmartTable.addStyleClass("sapUiMediumMarginBeginEnd");var n=this.getResourceBundle().getText("NoDataText");this._oWorklistSmartTable.setNoData(n);this.oRouter.attachRouteMatched(this.onRouteMatched,this);this.initUploaderPressEvent();this.initAppState();},initAppState:function(){var p=this.oNavigationHandler.parseNavigation();var t=this;p.done(function(A,u,n){if(n!==sap.ui.generic.app.navigation.service.NavType.initial){if(A.customData){if(A.customData.RootKey&&A.customData.Key){t.singleCheck(A.customData);}}}});p.fail(function(e){t._handleError(e);});},initUploaderPressEvent:function(){var o=this.byId(C.FileUploaderID);var d=o.onmousedown;var t=this;o.onmousedown=function(e){var i=t._oWorklistTable.getItems();if(i.length===0){d.call(this,e);}else{b.error(t.getResourceBundle().getText("ClearFirst"));}};},onBeforeRendering:function(){var s="sapUiSizeCozy",d="sapUiSizeCompact",e="sapUiSizeCondensed";if(this._oWorklistTable){if(jQuery(document.body).hasClass(d)||this.getOwnerComponent().getContentDensityClass()===d){this._oWorklistTable.addStyleClass(e);}else if(jQuery(document.body).hasClass(s)||this.getOwnerComponent().getContentDensityClass()===s){this._oWorklistTable.addStyleClass(s);}}},onRouteMatched:function(e){var p=e.getParameter("name");if(p==="worklist"){}else if(p==="worklist-external"){}this._getPostEnabled();this._featureToggleForEdit();},onRowSelectionChange:function(e){var s=[];var u=this.getView().getModel("ui");s=this._oWorklistTable.getSelectedItems();if(s.length>0){u.setProperty("/postBtnEnabled",true);}else{u.setProperty("/postBtnEnabled",false);}if(s.length===1){var l=s[0];var o=l.getBindingContext().getObject();this.RootKey=o.RootKey;this.Key=o.Key;}else{this.RootKey=undefined;this.Key=undefined;}},onTableDataReceived:function(e){this._oWorklistTable.fireSelectionChange();if(e.getParameters().getSource().getLength()===0){this.byId(C.FileUploaderID).setValue();}},onBeforeRebindViewTable:function(e){var o=e.getParameter("bindingParams");if(o){var s;s=this._createSorter();o.sorter=s;}},_createSorter:function(){var r;var s=new S("CheckStatus",false,false);var o=new S("CompanyCode",false,false);var d=new S("InvoicingParty",false,false);var e=new S("DocumentDate",false,false);var g=new S("PostingDate",false,false);var h=new S("Currency",false,false);var i=new S("Amount",false,false);r=[s,o,d,e,g,h,i];return r;},onNavBack:function(){var p=H.getInstance().getPreviousHash(),o=sap.ushell.Container.getService("CrossApplicationNavigation");if(p!==undefined||!o.isInitialNavigation()){history.go(-1);}else{}},onFileChange:function(){this._addTokenToUploader();var o=this.byId(C.FileUploaderID);var i=this._oWorklistTable.getItems();if(o.getValue()&&i.length===0){o.upload();this._oPage.setBusy(true);}else if(i.length>0){b.error(this.getResourceBundle().getText("ClearFirst"));}},handleUploadCompleted:function(e){var t=this;var r=e.getParameters("response");var R=r.responseRaw;if(r.status===201){var u=this._parseUploadedInfo(R);if(u.iTotalUpload!=="1"){M.show(this.getResourceBundle().getText("UploadSuccess",u.iTotalUpload));}else{M.show(this.getResourceBundle().getText("SingleUploadSuccess",u.iTotalUpload));}this._oWorklistSmartTable.rebindTable();}else{if(R==="CSRF token validation failed"){this._oPage.setBusy(false);b.error(this.getResourceBundle().getText("LoginTimeOutMsg"),{onClose:function(){t._oWorklistSmartTable.rebindTable();}});return;}var m=this._parseUploadMessage(R);if(this.warningMessage===false){var h="";if(m.length>0){var s=this.getResourceBundle().getText("UploadFailedHeader");h="<p>"+s+"</p>"+"<ul>";for(var i=0;i<m.length;i++){h=h+"<li>"+m[i].ErrorMessage+"</li>";}var d=this.getResourceBundle().getText("UploadFailedHelp");var g=this.getResourceBundle().getText("SAPHelp");h=h+"</ul>"+"<p>"+d+" <a href=\"//help.sap.com\">"+g+"</a>.</p>";b.error(this.getResourceBundle().getText("UploadFailed"),{onClose:function(){t._oWorklistSmartTable.rebindTable();},details:h});}else{b.error(this.getResourceBundle().getText("ErrorOccur"));}}else{if(m.length>0){var w;for(var j=0;j<m.length;j++){w=w+m[j].ErrorMessage+"/n";}b.warning(w);}}}this._oPage.setBusy(false);},_addTokenToUploader:function(){var d=this.getOwnerComponent().getModel();var t=d.getSecurityToken();var o=this.byId(C.FileUploaderID);var h=new sap.ui.unified.FileUploaderParameter({name:"X-CSRF-Token",value:t});o.removeAllHeaderParameters();o.addHeaderParameter(h);var u=d.sServiceUrl+C.UploadEntitySet;o.setUploadUrl(u);},_parseUploadedInfo:function(r){var t,i,d;var p={};i=r.indexOf("<d:NumberOfDocumentsUploaded>");d=r.indexOf("</d:NumberOfDocumentsUploaded>");if(i!==-1&&d!==-1){t=r.slice(i+29,d);p.iTotalUpload=t;}return p;},_parseUploadMessage:function(r){var x;var m=[];try{x=jQuery.parseXML(r);}catch(e){x=null;}if(x){var o=x.getElementsByTagName("errordetails");if(o&&(o.length>0)&&o[0].childNodes&&o[0].childNodes.length>0){var d=o[0].childNodes;var l=d.length;var s,g,h;if(l>1){this.warningMessage=true;for(var i=0;i<l;i++){s=d[i].getElementsByTagName("code")[0].textContent;g=d[i].getElementsByTagName("message")[0].textContent;h=d[i].getElementsByTagName("severity")[0].textContent;if(s!=="/IWBEP/CX_MGW_BUSI_EXCEPTION"&&(h==="error"||h==="warning")){if(h==="error"){this.warningMessage=false;}var j={ErrorMessage:g,MessageType:h};m.push(j);}}}else if(l===1){s=d[0].getElementsByTagName("code")[0].textContent;g=d[0].getElementsByTagName("message")[0].textContent;h=d[0].getElementsByTagName("severity")[0].textContent;if(h==="error"){this.warningMessage=false;}if(s!=="/IWBEP/CX_MGW_BUSI_EXCEPTION"){var k={ErrorMessage:g,MessageType:h};m.push(k);}}}else{var n=x.getElementsByTagName("message");if(n&&n.length>0){this.warningMessage=false;g=n[0].textContent;var p={ErrorMessage:g,MessageType:"error"};m.push(p);}}}return m;},handleDownloadPress:function(){var s="XLSX";var l=this.byId(C.DownloadLanguageDropdownID);var L=l.getSelectedKey();if(!L){L=sap.ui.getCore().getConfiguration().getLocale().getLanguage();}var d=this.getOwnerComponent().getModel();var e=d.sServiceUrl;var n=this.getResourceBundle().getText('Supplier_Invoice')+'_'+L;var g=e+"/FilesContentForDownload(IsTemplate=1,Mimetype='"+s+"')/$value?$filter=Language eq '"+L+"' and FileName eq '"+n+".";g=g+s+"'";window.open(g);this._oDownloadDialog.close();},onDownloadPress:function(){if(!this._oDownloadDialog){this._oDownloadDialog=sap.ui.xmlfragment(this.getView().getId(),C.DownloadDialogFragmentID,this);this.getView().addDependent(this._oDownloadDialog);}this._oDownloadDialog.open();},onDownloadCancelPressed:function(){this._oDownloadDialog.close();},handleItemPressed:function(e){var t=this;var l=e.getParameter("listItem");var o=l.getBindingContext().getObject();var r=o.RootKey;var k=o.Key;if(r){var s="SupplierInvoice";var A="process";var n={DBKey:r};if(o.StatusCode!=="10"&&o.FiscalYear!=="0000"&&o.SupplierInvoice!==""){n.FiscalYear=o.FiscalYear;n.SupplierInvoice=o.SupplierInvoice;}var i={customData:{RootKey:r,Key:k}};var O=function(d){b.error(t.getResourceBundle().getText("OUTBOUND_NAV_ERROR"));};this.oNavigationHandler.navigate(s,A,n,i,O);}},handleShowLogPress:function(e){this.onShowLogButtonPressed(e);},onShowLogButtonPressed:function(e){var s=this._oWorklistTable.getSelectedItems();if(s.length!==1){this.navToApplicationLog();}else{if(!this.Key){var l=s[0];var o=l.getBindingContext().getObject();this.Key=o.Key;}this.getLoghandle(this.Key);}},navToApplicationLog:function(){var t=this;var p={"LogObjectId":"FAP_ISI","LogExternalId":"","PersKey":"fin.ap.invoice.upload.ShowLog"};if(this.RootKey){p.LogExternalId=this.RootKey;}var i={};this.oRouter.detachRouteMatched(this.onRouteMatched,this);var o=function(e){b.error(t.getResourceBundle().getText("OUTBOUND_NAV_ERROR"));};this.oNavigationHandler.navigate("ApplicationLog","showList",p,i,o);},getLoghandle:function(k){var t=this;var p={Key:k};var s=jQuery.proxy(function(d,r){if(d&&d.GetLogHandle&&d.GetLogHandle.LogHandleID){var n={"LogHandle":d.GetLogHandle.LogHandleID};var i={customData:{}};var o=function(g){b.error(t.getResourceBundle().getText("OUTBOUND_NAV_ERROR"));};t.oNavigationHandler.navigate("ApplicationLog","showDetails",n,i,o);}else{t.navToApplicationLog();}},this);var e=jQuery.proxy(function(o){b.error(o.message,{onClose:function(){t._oWorklistSmartTable.rebindTable();},details:o.responseText});jQuery.sap.log.error("fin.ap.invoice.upload.controller.Worklist","Get Current User error, as "+o.message+"\r\n"+o.responseText);},this);var P=this.getView().getModel().callFunction("/GetLogHandle",{method:"POST",urlParameters:p,success:s,error:e});return P.contextCreated();},onPostPressed:function(){this.sAction="Post";this._onBtnPressed("Post");},onCheckPressed:function(){this.sAction="Check";this._onBtnPressed("Check");},onDeletePress:function(){this.sAction="Delete";this._onBtnPressed("Delete");},onSubmitPress:function(){this.sAction="Submit";this._onBtnPressed("ParkAsCompleted");},onEditPress:function(){this.sAction="Edit";this._onBtnPressed("Update");},_onBtnPressed:function(A){var t=this;var s=this._oWorklistTable.getSelectedItems();var o,e=[],d=[],g=[];this._aSelectedItems=this._oWorklistTable.getSelectedItems();this._iActionTotalNum=s.length;this._iActionNotFinished=s.length;this._iActionSuccessNum=0;this._iDuplicateCheckNotFinished=0;this._aEntriesNotDuplicate=[];if(s.length<=0){b.error(this.getResourceBundle().getText("SelectOneItem"));}else{for(var i=0;i<s.length;i++){var p={};o=s[i].getBindingContext().getObject();p.RootKey=o.RootKey;p.Key=o.Key;e.push(p);if(o.CheckDuplicate==="X"){d.push(p);}else{g.push(p);}}switch(A){case"Delete":{b.confirm(this.getResourceBundle().getText("DeleteConfirmation"),{title:this.getResourceBundle().getText("Delete"),actions:[sap.m.MessageBox.Action.DELETE,sap.m.MessageBox.Action.CANCEL],onClose:function(h){if(h===sap.m.MessageBox.Action.DELETE){t._doActionSelectedDocuments(A,e);}}});break;}case"Update":{if(!this._oEditDialogCtrl){this._oEditDialogCtrl=new E(this,e);}if(!this._oEditDialog){this._oEditDialog=sap.ui.xmlfragment(this.getView().getId(),C.EditDialogFragmentID,this._oEditDialogCtrl);this.getView().addDependent(this._oEditDialog);}this._oEditDialog.open();break;}case"Post":case"Check":{this._doActionSelectedDocuments("DuplicateCheck",d,A);this._doActionSelectedDocuments(A,g);break;}default:{this._doActionSelectedDocuments(A,e);break;}}}},_doActionSelectedDocuments:function(A,i,s,u){var d,o,g;var r=(u===undefined)?{}:u;if(i&&i.length>0){switch(A){case"Post":{var e=i.length;var n=10;var h=Math.ceil(e/n);d=0;for(var j=0;j<h;j++){var k="";for(var t=0;t<n;t++){if(d<e){o=i[d];if(k===""){k=o.RootKey+"+"+o.Key;}else{k=o.RootKey+"+"+o.Key+","+k;}d++;}}r.CombinedKey=k;g=A+d;this._singlePostThroughGUID(r,g);}break;}case"DuplicateCheck":{this._iDuplicateCheckNotFinished=i.length;for(d=0;d<i.length;d++){o=i[d];r.Key=o.Key;this._singleDuplicateCheckThroughGUID(r);}break;}default:{for(d=0;d<i.length;d++){o=i[d];r.RootKey=o.RootKey;r.Key=o.Key;g=A+d;this._singleActionThroughGUID(A,r,g);}break;}}this._oPage.setBusy(true);if(A==="DuplicateCheck"){this._checkDuplicateCheckFinish(s);}else{this._checkBatchRequestFinish();}}},_checkBatchRequestFinish:function(){if(this._iActionNotFinished<=0){this._oWorklistSmartTable.rebindTable();this._showPostFinishInfoMsgBox();this._oPage.setBusy(false);}else{jQuery.sap.delayedCall(50,this,this._checkBatchRequestFinish);}},_checkDuplicateCheckFinish:function(A){if(this._iDuplicateCheckNotFinished<=0){if(this._aEntriesNotDuplicate.length!==0){this._doActionSelectedDocuments(A,this._aEntriesNotDuplicate);}else{this._checkBatchRequestFinish();}}else{jQuery.sap.delayedCall(50,this,this._checkDuplicateCheckFinish,[A]);}},_singlePostThroughGUID:function(p,g){var P=jQuery.proxy(function(e,r){var i;if(e.Post&&e.Post.Counter){i=e.Post.Counter;}if(i>=0){this._iActionSuccessNum+=i;}else{var m=r.headers["sap-message"];if(m){try{var h=jQuery.parseJSON(m);var j=h.getElementsByTagName("errordetails");if(j&&j[0].childNodes){var k=j[0].childNodes;var s=k[0].getElementsByTagName("message")[0].textContent;var l=k[0].getElementsByTagName("severity")[0].textContent;if(l==="error"){b.error(s);}}}catch(n){jQuery.sap.log.error("fin.ap.invoice.upload.controller.Worklist","parse error, as "+n.message);}}}this._iActionNotFinished=this._iActionNotFinished-10;},this);var d=jQuery.proxy(function(e){this._iActionNotFinished=this._iActionNotFinished-10;b.error(e.message,{details:e.responseText});},this);var o=this.getView().getModel().callFunction("/Post",{method:"GET",urlParameters:p,groupId:g,success:P,error:d});return o.contextCreated();},_singleActionThroughGUID:function(A,p,g){var s=jQuery.proxy(function(o,r){var i;var h=o[A];if(h&&h.ActionOk!==false){i=1;}else{i=0;}if(i>0){this._iActionSuccessNum+=i;}else{var m=r.headers["sap-message"];if(m){try{var j=jQuery.parseJSON(m);b.error(j.message);}catch(k){jQuery.sap.log.error("fin.ap.invoice.upload.controller.Worklist","parse error, as "+k.message);}}}this._iActionNotFinished--;},this);var e=jQuery.proxy(function(o){this._iActionNotFinished--;b.error(o.message,{details:o.responseText});},this);var d="/"+A;var P=this.getView().getModel().callFunction(d,{method:"GET",urlParameters:p,groupId:g,success:s,error:e});return P.contextCreated();},_singleDuplicateCheckThroughGUID:function(p){var A="DuplicateCheck";var d=jQuery.proxy(function(o,r){this._iDuplicateCheckNotFinished--;var g=o[A];if(g){if(g.ActionOk===true){var h={RootKey:g.RootKey,Key:g.Key};this._aEntriesNotDuplicate.push(h);}else{this._iActionNotFinished--;}}},this);var e=jQuery.proxy(function(o){this._iDuplicateCheckNotFinished--;b.error(o.message,{details:o.responseText});},this);var P=this.getView().getModel().callFunction("/DuplicateCheck",{method:"POST",urlParameters:p,success:d,error:e});return P.contextCreated();},_getPostEnabled:function(){var A="PostEnabled";var s=jQuery.proxy(function(o,r){var g=o[A];if(g){if(g.ActionOk===true){var u=this.getView().getModel("ui");u.setProperty("/postBtnVisible",true);}}else{b.error(this.getResourceBundle().getText("ErrorOccur"));}},this);var e=jQuery.proxy(function(o){b.error(o.message,{details:o.response});jQuery.sap.log.error("fin.ap.invoice.upload.controller.Worklist","Get PostEnabled error, as "+o.message+"\r\n"+o.response);},this);var d="/"+A;var p=this.getView().getModel().callFunction(d,{method:"GET",success:s,error:e});return p.contextCreated();},singleCheck:function(p){var d=jQuery.proxy(function(o,r){this._oPage.setBusy(false);this._oWorklistSmartTable.rebindTable();},this);var e=jQuery.proxy(function(o){this._oPage.setBusy(false);this._oWorklistSmartTable.rebindTable();b.error(o.message,{details:o.responseText});},this);var m=this.getOwnerComponent().getModel();m.callFunction("/Check",{method:"GET",urlParameters:p,success:d,error:e});this._oPage.setBusy(true);},_showPostFinishInfoMsgBox:function(){var u=this.getView().getModel("ui");var n=this._iActionSuccessNum.toString();var e=this._iActionTotalNum-this._iActionSuccessNum;var s,d;if(e>0){u.setProperty("/Success",false);u.setProperty("/Error",true);}else{u.setProperty("/Success",true);u.setProperty("/Error",false);}switch(this.sAction){case"Check":{s=(this._iActionSuccessNum===1)?this.getResourceBundle().getText("SingleCheckedSuccess",n):this.getResourceBundle().getText("CheckedSuccess",n);d=(e===1)?this.getResourceBundle().getText("SingleCheckedFailed",e):this.getResourceBundle().getText("CheckedFailed",e);break;}case"Delete":{s=(this._iActionSuccessNum===1)?this.getResourceBundle().getText("SingleDeletedSuccess",n):this.getResourceBundle().getText("DeletedSuccess",n);d=(e===1)?this.getResourceBundle().getText("SingleDeletedFailed",e):this.getResourceBundle().getText("DeletedFailed",e);break;}case"Submit":{s=(this._iActionSuccessNum===1)?this.getResourceBundle().getText("SingleSubmitSuccess",n):this.getResourceBundle().getText("SingleSubmitSuccess",n);d=(e===1)?this.getResourceBundle().getText("SubmitFailed",e):this.getResourceBundle().getText("SubmitFailed",e);break;}case"Edit":{s=(this._iActionSuccessNum===1)?this.getResourceBundle().getText("SingleEditSuccess",n):this.getResourceBundle().getText("EditSuccess",n);d=(e===1)?this.getResourceBundle().getText("SingleEditFailed",e):this.getResourceBundle().getText("EditFailed",e);break;}case"Post":{s=(this._iActionSuccessNum===1)?this.getResourceBundle().getText("SinglePostedSuccess",n):this.getResourceBundle().getText("PostedSuccess",n);d=(e===1)?this.getResourceBundle().getText("SinglePostedFailed",e):this.getResourceBundle().getText("PostedFailed",e);break;}default:{break;}}u.setProperty("/SuccessText",s);u.setProperty("/ErrorText",d);this.openMessageBox();},openMessageBox:function(){if(!this._oMessageDialog){this._oMessageDialog=sap.ui.xmlfragment(this.getView().getId(),C.MessageDialogFragmentID,this);this.getView().addDependent(this._oMessageDialog);}this._oMessageDialog.addStyleClass("sapMMessageBoxInfo");this._oMessageDialog.setIcon(c.getIconURI("message-information"));this._oMessageDialog.setTitle(this.getResourceBundle().getText("Information"));this._oMessageDialog.open();},onMessageCancelPressed:function(){this._oMessageDialog.close();},_featureToggleForEdit:function(){var s=jQuery.proxy(function(d,r){if(d&&d.results){if(d.results[0].ToggleId==="FI_AP_ISI_EDIT"&&d.results[0].ToggleActive===true){var u=this.getView().getModel("ui");u.setProperty("/editBtnVisible",true);}}else{b.error(this.getResourceBundle().getText("ErrorOccur"));}},this);var e=jQuery.proxy(function(o){b.error(o.message,{details:o.response});jQuery.sap.log.error("fin.ap.invoice.upload.controller.Worklist","Get Feature Toggle error, as "+o.message+"\r\n"+o.response);},this);this.getOwnerComponent().getModel().read("/FeatureToggleSet",{success:s,error:e});}});});
